<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="MiraiPalette.WinUI.Views.ImagePalettePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:behaviors="using:CommunityToolkit.WinUI.Behaviors"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:e="using:MiraiPalette.WinUI.Essentials"
    xmlns:helpers="using:MiraiPalette.WinUI.Helpers"
    xmlns:i="using:Microsoft.Xaml.Interactivity"
    xmlns:local="using:MiraiPalette.WinUI.Views"
    xmlns:localization="using:MiraiPalette.WinUI.Strings"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="using:CommunityToolkit.WinUI"
    xmlns:vm="using:MiraiPalette.WinUI.ViewModels"
    NavigationCacheMode="Disabled"
    mc:Ignorable="d">
    <Page.Resources>
        <MenuFlyout x:Key="MiraiColorItemContextFlyout">
            <MenuFlyoutItem
                Command="{x:Bind ViewModel.DeleteCurrentOrSelectedColorsCommand, Mode=OneTime}"
                CommandParameter="{Binding}"
                Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                Icon="{ui:SymbolIcon Symbol=Delete}"
                Text="{x:Bind localization:Resources.Delete, Mode=OneTime}" />
        </MenuFlyout>
        <DataTemplate
            x:Key="MiraiColorItemTemplate"
            x:DataType="vm:ColorViewModel">
            <Grid
                Height="48"
                ContextFlyout="{StaticResource MiraiColorItemContextFlyout}"
                CornerRadius="{StaticResource ControlCornerRadius}">
                <Rectangle
                    Margin="96,0,0,0"
                    HorizontalAlignment="Stretch"
                    Fill="{x:Bind Color, Mode=OneTime, Converter={StaticResource ColorToBrushConverter}}" />
                <Border
                    Width="144"
                    HorizontalAlignment="Left"
                    Background="{ThemeResource AcrylicBackgroundFillColorDefaultBrush}">
                    <TextBlock
                        Margin="16,0,0,0"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Center"
                        Text="{x:Bind Name, Mode=OneTime}" />
                </Border>
            </Grid>
        </DataTemplate>
    </Page.Resources>
    <Grid
        Padding="8"
        RowSpacing="4">
        <Grid.RowDefinitions>
            <RowDefinition
                Height="*"
                MinHeight="160" />
            <RowDefinition Height="Auto" />
            <RowDefinition
                Height="*"
                MinHeight="160" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <Grid
            x:Name="ImagePanel"
            Padding="4"
            ColumnSpacing="16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <ScrollViewer
                x:Name="ImageScrollView"
                Background="{ThemeResource ControlFillColorDefaultBrush}"
                CornerRadius="{StaticResource ControlCornerRadius}"
                HorizontalScrollBarVisibility="Auto"
                HorizontalScrollMode="Enabled"
                IsTabStop="True"
                IsVerticalScrollChainingEnabled="True"
                SizeChanged="ImageScrollView_SizeChanged"
                VerticalScrollBarVisibility="Auto"
                VerticalScrollMode="Enabled"
                ZoomMode="Enabled">
                <Image
                    x:Name="SourceImage"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    ImageOpened="SourceImage_ImageOpened"
                    PointerEntered="SourceImage_PointerEntered"
                    PointerExited="SourceImage_PointerExited"
                    PointerMoved="OnImage_PointerMoved"
                    Source="{x:Bind helpers:BindHelper.ToBitmapImage(ViewModel.ImagePath), Mode=OneWay}"
                    Stretch="None">
                    <i:Interaction.Behaviors>
                        <i:EventTriggerBehavior EventName="PointerPressed">
                            <i:InvokeCommandAction Command="{x:Bind ViewModel.AddPickedColorCommand, Mode=OneTime}" />
                        </i:EventTriggerBehavior>
                    </i:Interaction.Behaviors>
                </Image>
            </ScrollViewer>
            <StackPanel
                Grid.Column="1"
                Padding="4"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Background="{ThemeResource ControlFillColorDefaultBrush}"
                CornerRadius="{StaticResource ControlCornerRadius}"
                Orientation="Vertical"
                Spacing="4">
                <TextBlock Text="{x:Bind ImageScrollView.ZoomFactor, Mode=OneWay, Converter={StaticResource StringFormatConverter}, ConverterParameter=' {0:P0}'}" />
                <Button
                    x:Name="FitImageSizeToPanelButton"
                    Click="FitImageSizeToPanelButton_Click"
                    Content="{ui:FontIcon Glyph=&#xE9A6;}"
                    Style="{StaticResource ToolButtonStyle}"
                    ToolTipService.ToolTip="{x:Bind localization:ImagePalettePageStrings.FitSizeButton_Tooltip, Mode=OneTime}" />
                <Button
                    x:Name="ImageZoomInButton"
                    Click="ImageZoomInButton_Click"
                    Content="{ui:SymbolIcon Symbol=ZoomIn}"
                    Style="{StaticResource ToolButtonStyle}"
                    ToolTipService.ToolTip="{x:Bind localization:ImagePalettePageStrings.ZoomInButton_Tooltip, Mode=OneTime}" />
                <Button
                    x:Name="ImageZoomOutButton"
                    Click="ImageZoomOutButton_Click"
                    Content="{ui:SymbolIcon Symbol=ZoomOut}"
                    Style="{StaticResource ToolButtonStyle}"
                    ToolTipService.ToolTip="{x:Bind localization:ImagePalettePageStrings.ZoomOutButton_Tooltip, Mode=OneTime}" />
            </StackPanel>
            <StackPanel
                x:Name="ColorPreviewPanel"
                Width="64"
                Padding="4"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Background="{ThemeResource AcrylicBackgroundFillColorDefaultBrush}"
                CornerRadius="{StaticResource ControlCornerRadius}"
                Spacing="4"
                Visibility="Collapsed">
                <Rectangle
                    Height="32"
                    HorizontalAlignment="Stretch"
                    Fill="{x:Bind ViewModel.PointerPixel, Mode=OneWay, Converter={StaticResource ColorToBrushConverter}}"
                    RadiusX="4"
                    RadiusY="4" />
                <TextBlock
                    FontSize="{StaticResource CaptionTextBlockFontSize}"
                    Text="{x:Bind ViewModel.PointerPixelHex, Mode=OneWay}" />
            </StackPanel>
        </Grid>
        <controls:GridSplitter
            Grid.Row="1"
            Height="12"
            VerticalAlignment="Center"
            CornerRadius="{StaticResource ControlCornerRadius}" />
        <Grid
            x:Name="PalettePanel"
            Grid.Row="2"
            Padding="4"
            ColumnSpacing="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <Grid RowSpacing="4">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <controls:WrapPanel
                    Padding="4"
                    HorizontalSpacing="8"
                    Orientation="Horizontal"
                    VerticalSpacing="4">
                    <FontIcon
                        VerticalAlignment="Center"
                        Glyph="&#xE950;" />
                    <TextBlock
                        FontSize="{StaticResource SubtitleTextBlockFontSize}"
                        Text="{x:Bind localization:ImagePalettePageStrings.AutoColorsList_Title, Mode=OneTime}" />
                    <NumberBox
                        Width="64"
                        Margin="8,0,0,0"
                        LargeChange="4"
                        Maximum="{x:Bind ViewModel.MaximumColorCount, Mode=OneTime}"
                        Minimum="{x:Bind ViewModel.MinimumColorCount, Mode=OneTime}"
                        SmallChange="1"
                        SpinButtonPlacementMode="Compact"
                        ValueChanged="ColorCountNumberBox_ValueChanged"
                        Value="{x:Bind ViewModel.ColorCount, Mode=TwoWay}" />
                    <Button Command="{x:Bind ViewModel.ExtractPaletteCommand, Mode=OneTime}">
                        <StackPanel
                            Orientation="Horizontal"
                            Spacing="8">
                            <SymbolIcon Symbol="Play" />
                            <TextBlock
                                FontSize="16"
                                Text="{x:Bind localization:ImagePalettePageStrings.AutoExtractButton_Text, Mode=OneTime}" />
                        </StackPanel>
                    </Button>
                    <Button
                        Command="{x:Bind ViewModel.ClearAutoColorsCommand, Mode=OneTime}"
                        Content="{ui:SymbolIcon Symbol=Clear}"
                        Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                        ToolTipService.ToolTip="{x:Bind localization:ImagePalettePageStrings.ColorsListClearButton_Tooltip, Mode=OneTime}"
                        Visibility="{x:Bind ViewModel.HasAutoColors, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay}" />
                </controls:WrapPanel>
                <ListView
                    x:Name="AutoColorListView"
                    Grid.Row="1"
                    Padding="4,8"
                    Background="{ThemeResource ControlFillColorDefaultBrush}"
                    CornerRadius="{StaticResource ControlCornerRadius}"
                    IsItemClickEnabled="True"
                    ItemTemplate="{StaticResource MiraiColorItemTemplate}"
                    ItemsSource="{x:Bind ViewModel.AutoColors, Mode=OneWay}"
                    SelectionMode="Extended">
                    <i:Interaction.Behaviors>
                        <i:EventTriggerBehavior EventName="SelectionChanged">
                            <i:InvokeCommandAction
                                Command="{x:Bind ViewModel.SelectAutoColorsCommand, Mode=OneTime}"
                                CommandParameter="{x:Bind AutoColorListView.SelectedItems, Mode=OneTime}" />
                        </i:EventTriggerBehavior>
                    </i:Interaction.Behaviors>
                </ListView>
            </Grid>
            <Grid
                Grid.Column="1"
                RowSpacing="4">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <controls:WrapPanel
                    Padding="4"
                    HorizontalSpacing="8"
                    Orientation="Horizontal"
                    VerticalSpacing="4">
                    <FontIcon
                        VerticalAlignment="Center"
                        Glyph="&#xE77B;" />
                    <TextBlock
                        VerticalAlignment="Center"
                        FontSize="{StaticResource SubtitleTextBlockFontSize}"
                        Text="{x:Bind localization:ImagePalettePageStrings.ManualColorsList_Title, Mode=OneTime}" />
                    <ToggleButton IsChecked="{x:Bind ViewModel.IsPickingColor, Mode=TwoWay}">
                        <StackPanel
                            Orientation="Horizontal"
                            Spacing="8">
                            <FontIcon Glyph="&#xEF3C;" />
                            <TextBlock
                                FontSize="16"
                                Text="{x:Bind localization:ImagePalettePageStrings.ColorPickerToggleButton_Text, Mode=OneTime}" />
                        </StackPanel>
                    </ToggleButton>
                    <Button
                        Command="{x:Bind ViewModel.ClearManualColorsCommand, Mode=OneTime}"
                        Content="{ui:SymbolIcon Symbol=Clear}"
                        Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                        ToolTipService.ToolTip="{x:Bind localization:ImagePalettePageStrings.ColorsListClearButton_Tooltip, Mode=OneTime}"
                        Visibility="{x:Bind ViewModel.HasManualColors, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay}" />
                </controls:WrapPanel>
                <ListView
                    x:Name="ManualColorListView"
                    Grid.Row="1"
                    Padding="4,8"
                    Background="{ThemeResource ControlFillColorDefaultBrush}"
                    CornerRadius="{StaticResource ControlCornerRadius}"
                    IsItemClickEnabled="True"
                    ItemTemplate="{StaticResource MiraiColorItemTemplate}"
                    ItemsSource="{x:Bind ViewModel.ManualColors, Mode=OneTime}"
                    SelectionMode="Extended">
                    <i:Interaction.Behaviors>
                        <i:EventTriggerBehavior EventName="SelectionChanged">
                            <i:InvokeCommandAction
                                Command="{x:Bind ViewModel.SelectManualColorsCommand, Mode=OneTime}"
                                CommandParameter="{x:Bind ManualColorListView.SelectedItems, Mode=OneTime}" />
                        </i:EventTriggerBehavior>
                    </i:Interaction.Behaviors>
                </ListView>
            </Grid>
        </Grid>
        <StackPanel
            Grid.Row="3"
            Padding="4"
            HorizontalAlignment="Center"
            Orientation="Horizontal"
            Spacing="4">
            <Button
                x:Name="CompleteButton"
                Width="120"
                HorizontalAlignment="Stretch"
                Command="{x:Bind ViewModel.SavePaletteCommand, Mode=OneTime}"
                IsEnabled="{x:Bind ViewModel.CanSavePalette, Mode=OneWay}"
                Style="{StaticResource AccentButtonStyle}">
                <Button.Content>
                    <StackPanel
                        Orientation="Horizontal"
                        Spacing="4">
                        <FontIcon Glyph="&#xE73E;" />
                        <TextBlock Text="{x:Bind localization:Resources.Complete, Mode=OneTime}" />
                    </StackPanel>
                </Button.Content>
            </Button>
        </StackPanel>
    </Grid>
</Page>
